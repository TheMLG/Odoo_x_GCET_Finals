// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}


datasource db {
  provider = "postgresql"
}

// SQL Server doesn't support enums, using String with validated values in application layer
// Valid RoleName values: ADMIN, VENDOR, CUSTOMER
// Valid CartStatus values: ACTIVE, CONVERTED
// Valid OrderStatus values: CONFIRMED, PICKED_UP, RETURNED, CANCELLED
// Valid PricingType values: HOUR, DAY, WEEK
// Valid InvoiceStatus values: DRAFT, PARTIAL, PAID
// Valid PaymentStatus values: PENDING, SUCCESS, FAILED

model User {
  id         String      @id @default(uuid())
  email      String      @unique
  password   String
  firstName  String
  lastName   String
  createdAt DateTime    @default(now())
  
  otp        String?
  otpExpiry  DateTime?

  roles      UserRole[]
  vendor     Vendor?
  carts      Cart[]
  orders     Order[]
  wishlists  Wishlist[]
  addresses  Address[]
  coupons    Coupon[]
}

model Role {
  id    String   @id @default(uuid())
  name  String   @unique // Valid: ADMIN, VENDOR, CUSTOMER

  users UserRole[]
}

model UserRole {
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
}

model Vendor {
  id          String   @id @default(uuid())
  userId      String   @unique
  companyName String
  gstNo       String
  product_category String
  createdAt  DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  products Product[]
  orders   Order[]
}

model Product {
  id          String   @id @default(uuid())
  vendorId    String
  name        String
  description String?
  category    String @default("Uncategorized")
  product_image_url String @default("https://static.vecteezy.com/system/resources/thumbnails/051/739/975/small_2x/cosmetic-products-mock-up-photo.jpg")
  isPublished Boolean  @default(false)
  createdAt  DateTime @default(now())

  vendor       Vendor             @relation(fields: [vendorId], references: [id])
  inventory    ProductInventory?
  pricing      RentalPricing[]
  attributes   ProductAttribute[]
  cartItems    CartItem[]
  orderItems   OrderItem[]
  reservations Reservation[]
  wishlistItems WishlistItem[]
}

model ProductInventory {
  id        String @id @default(uuid())
  productId String @unique
  totalQty  Int

  product Product @relation(fields: [productId], references: [id])
}

model RentalPricing {
  id         String      @id @default(uuid())
  productId String
  type       String      // Valid: HOUR, DAY, WEEK
  price      Decimal

  product Product @relation(fields: [productId], references: [id])

  @@unique([productId, type])
}

model Attribute {
  id   String @id @default(uuid())
  name String @unique

  values AttributeValue[]
}

model AttributeValue {
  id          String
  attributeId String
  value       String

  attribute Attribute @relation(fields: [attributeId], references: [id])
  products  ProductAttribute[]

  @@id([id, attributeId])
}

model ProductAttribute {
  productId        String
  attributeValueId String
  attributeId      String

  product        Product        @relation(fields: [productId], references: [id])
  attributeValue AttributeValue @relation(fields: [attributeValueId, attributeId], references: [id, attributeId])

  @@id([productId, attributeValueId, attributeId])
}

model Cart {
  id        String     @id @default(uuid())
  userId    String
  status    String     @default("ACTIVE") // Valid: ACTIVE, CONVERTED
  createdAt DateTime   @default(now())

  user  User       @relation(fields: [userId], references: [id])
  items CartItem[]
}

model CartItem {
  id          String   @id @default(uuid())
  cartId      String
  productId   String
  quantity    Int
  rentalStart DateTime
  rentalEnd   DateTime
  unitPrice   Decimal

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  product Product @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model Order {
  id        String      @id @default(uuid())
  userId    String
  vendorId  String
  deliveryAddressId String?
  couponId  String?
  discountAmount Decimal  @default(0)
  orderNumber String      @unique @default(cuid())
  status    String      // Valid: CONFIRMED, INVOICED, RETURNED, CANCELLED
  createdAt DateTime    @default(now())

  user            User        @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  vendor          Vendor      @relation(fields: [vendorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  deliveryAddress Address?    @relation(fields: [deliveryAddressId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  coupon          Coupon?     @relation(fields: [couponId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  items           OrderItem[]
  invoice         Invoice?
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String
  productId   String
  quantity    Int
  rentalStart DateTime
  rentalEnd   DateTime
  unitPrice   Decimal

  order        Order        @relation(fields: [orderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  product      Product      @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reservations Reservation[]
}

model Reservation {
  id          String   @id @default(uuid())
  orderItemId String
  productId   String
  reservedFrom DateTime
  reservedTo   DateTime
  quantity     Int

  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  product   Product   @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model Invoice {
  id          String        @id @default(uuid())
  invoiceNumber String      @unique @default(cuid())
  orderId     String        @unique
  totalAmount Decimal
  gstAmount   Decimal
  status      String        // Valid: DRAFT, PARTIAL, PAID
  createdAt   DateTime      @default(now())

  order    Order     @relation(fields: [orderId], references: [id])
  payments Payment[]
}

model Payment {
  id        String        @id @default(uuid())
  invoiceId String
  amount    Decimal
  mode      String
  status    String        // Valid: PENDING, SUCCESS, FAILED
  transactionId String?
  paidAt    DateTime?
  createdAt DateTime      @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id])
}

model Wishlist {
  id        String   @id @default(uuid())
  userId    String
  createdAt DateTime @default(now())

  user  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items WishlistItem[]

  @@unique([userId])
}

model WishlistItem {
  id         String   @id @default(uuid())
  wishlistId String
  productId  String
  addedAt    DateTime @default(now())

  wishlist Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([wishlistId, productId])
}

model Address {
  id          String   @id @default(uuid())
  userId      String
  fullName    String
  phoneNumber String
  addressLine1 String
  addressLine2 String?
  city        String
  state       String
  postalCode  String
  country     String   @default("India")
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]
}

model Coupon {
  id               String   @id @default(uuid())
  code             String   @unique
  description      String
  discountType     String   // Valid: PERCENTAGE, FIXED_AMOUNT
  discountValue    Decimal
  minOrderAmount   Decimal? // Minimum order required to apply coupon
  maxUsageCount    Int?     // Max total uses (null = unlimited)
  currentUsageCount Int     @default(0)
  expiryDate       DateTime?
  isActive         Boolean  @default(true)
  userId           String?  // For user-specific coupons (e.g., welcome coupons)
  isWelcomeCoupon  Boolean  @default(false) // Flag to identify welcome coupons
  createdAt        DateTime @default(now())

  user   User?   @relation(fields: [userId], references: [id])
  orders Order[]
}