generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  createdAt DateTime   @default(now())
  otp       String?
  otpExpiry DateTime?
  addresses Address[]
  carts     Cart[]
  coupons   Coupon[]
  orders    Order[]
  roles     UserRole[]
  vendor    Vendor?
  wishlists Wishlist?
  reviews    Review[]
}

model Role {
  id    String     @id @default(uuid())
  name  String     @unique
  users UserRole[]
}

model UserRole {
  userId String
  roleId String
  role   Role   @relation(fields: [roleId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@id([userId, roleId])
}

model Vendor {
  id               String    @id @default(uuid())
  userId           String    @unique
  companyName      String
  gstNo            String
  product_category String
  createdAt        DateTime  @default(now())
  orders           Order[]
  products         Product[]
  user             User      @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model Product {
  id                String             @id @default(uuid())
  vendorId          String
  name              String
  description       String?
  category          String             @default("Uncategorized")
  product_image_url String             @default("https://static.vecteezy.com/system/resources/thumbnails/051/739/975/small_2x/cosmetic-products-mock-up-photo.jpg")
  isPublished       Boolean            @default(false)
  attributeSchema   Json?
  createdAt         DateTime           @default(now())
  cartItems         CartItem[]
  orderItems        OrderItem[]
  vendor            Vendor             @relation(fields: [vendorId], references: [id])
  attributes        ProductAttribute[]
  variants          ProductVariant[]
  inventory         ProductInventory?
  pricing           RentalPricing[]
  reservations      Reservation[]
  wishlistItems     WishlistItem[]
  reviews      Review[]
}

model ProductVariant {
  id            String   @id @default(uuid())
  productId     String
  name          String?
  attributes    Json
  pricePerHour  Decimal?
  pricePerDay   Decimal
  pricePerWeek  Decimal?
  pricePerMonth Decimal?
  totalQty      Int
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  product       Product  @relation(fields: [productId], references: [id])
  cartItems     CartItem[]
  orderItems    OrderItem[]
  reservations  Reservation[]
}

model ProductInventory {
  id        String  @id @default(uuid())
  productId String  @unique
  totalQty  Int
  product   Product @relation(fields: [productId], references: [id])
}

model RentalPricing {
  id        String  @id @default(uuid())
  productId String
  type      String
  price     Decimal
  product   Product @relation(fields: [productId], references: [id])

  @@unique([productId, type])
}

model Attribute {
  id     String           @id @default(uuid())
  name   String           @unique
  values AttributeValue[]
}

model AttributeValue {
  id          String
  attributeId String
  value       String
  attribute   Attribute          @relation(fields: [attributeId], references: [id])
  products    ProductAttribute[]

  @@id([id, attributeId])
}

model ProductAttribute {
  productId        String
  attributeValueId String
  attributeId      String
  attributeValue   AttributeValue @relation(fields: [attributeValueId, attributeId], references: [id, attributeId])
  product          Product        @relation(fields: [productId], references: [id])

  @@id([productId, attributeValueId, attributeId])
}

model Cart {
  id        String     @id @default(uuid())
  userId    String
  status    String     @default("ACTIVE")
  createdAt DateTime   @default(now())
  user      User       @relation(fields: [userId], references: [id])
  items     CartItem[]
}

model CartItem {
  id          String   @id @default(uuid())
  cartId      String
  productId   String
  variantId   String?
  quantity    Int
  rentalStart DateTime
  rentalEnd   DateTime
  unitPrice   Decimal
  selectedAttributes Json?
  cart        Cart     @relation(fields: [cartId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  product     Product  @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  variant     ProductVariant? @relation(fields: [variantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model Order {
  id                String      @id @default(uuid())
  userId            String
  vendorId          String
  deliveryAddressId String?
  couponId          String?
  discountAmount    Decimal     @default(0)
  orderNumber       String      @unique @default(cuid())
  status            String
  createdAt         DateTime    @default(now())
  invoice           Invoice?
  coupon            Coupon?     @relation(fields: [couponId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  deliveryAddress   Address?    @relation(fields: [deliveryAddressId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user              User        @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  vendor            Vendor      @relation(fields: [vendorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  items             OrderItem[]
}

model OrderItem {
  id           String        @id @default(uuid())
  orderId      String
  productId    String
  variantId    String?
  quantity     Int
  rentalStart  DateTime
  rentalEnd    DateTime
  unitPrice    Decimal
  selectedAttributes Json?
  order        Order         @relation(fields: [orderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  product      Product       @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  variant      ProductVariant? @relation(fields: [variantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reservations Reservation[]
}

model Reservation {
  id           String    @id @default(uuid())
  orderItemId  String
  productId    String
  variantId    String?
  reservedFrom DateTime
  reservedTo   DateTime
  quantity     Int
  orderItem    OrderItem @relation(fields: [orderItemId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  product      Product   @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  variant      ProductVariant? @relation(fields: [variantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model Invoice {
  id            String    @id @default(uuid())
  invoiceNumber String    @unique @default(cuid())
  orderId       String    @unique
  totalAmount   Decimal
  gstAmount     Decimal
  status        String
  createdAt     DateTime  @default(now())
  order         Order     @relation(fields: [orderId], references: [id])
  payments      Payment[]
}

model Payment {
  id            String    @id @default(uuid())
  invoiceId     String
  amount        Decimal
  mode          String
  status        String
  transactionId String?   // Added to store Razorpay payment_id
  paidAt        DateTime?
  invoice       Invoice   @relation(fields: [invoiceId], references: [id])
}

model Wishlist {
  id        String         @id @default(uuid())
  userId    String         @unique
  createdAt DateTime       @default(now())
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     WishlistItem[]
}

model WishlistItem {
  id         String   @id @default(uuid())
  wishlistId String
  productId  String
  addedAt    DateTime @default(now())
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)

  @@unique([wishlistId, productId])
}

model Address {
  id           String   @id @default(uuid())
  userId       String
  fullName     String
  phoneNumber  String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  postalCode   String
  country      String   @default("India")
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders       Order[]
}

model Review {
  id        String   @id @default(uuid())
  productId String
  userId    String
  rating    Int      // 1-5 stars
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([productId, userId]) // One review per user per product
}

model Coupon {
  id                String    @id @default(uuid())
  code              String    @unique
  description       String
  discountType      String
  discountValue     Decimal
  minOrderAmount    Decimal?
  maxUsageCount     Int?
  currentUsageCount Int       @default(0)
  expiryDate        DateTime?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  orders            Order[]
  userId            String?
  user              User?     @relation(fields: [userId], references: [id])
  isWelcomeCoupon   Boolean   @default(false)
}

